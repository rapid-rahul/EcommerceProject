<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-commerce Authentication</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        .form-switch-link {
            cursor: pointer;
            color: #0d6efd;
            text-decoration: underline;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="auth-container">
        <h2 class="text-center mb-4" id="form-title">Sign In</h2>

        <div id="auth-alert" class="alert d-none" role="alert"></div>

        <form id="signin-form" class="auth-form">
            <div class="mb-3">
                <label for="signin-email" class="form-label">Email / Username</label>
                <input type="text" class="form-control" id="signin-email" name="username" required>
            </div>
            <div class="mb-3">
                <label for="signin-password" class="form-label">Password</label>
                <input type="password" class="form-control" id="signin-password" name="password" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Sign In</button>
        </form>

        <form id="signup-form" class="auth-form d-none">
            <div class="mb-3">
                <label for="signup-username" class="form-label">Username</label>
                <input type="text" class="form-control" id="signup-username" name="username" required minlength="3">
            </div>
            <div class="mb-3">
                <label for="signup-email" class="form-label">Email</label>
                <input type="email" class="form-control" id="signup-email" name="email" required>
            </div>
            <div class="mb-3">
                <label for="signup-password" class="form-label">Password</label>
                <input type="password" class="form-control" id="signup-password" name="password" required minlength="6">
            </div>
            <input type="hidden" name="role" value="user">
            <button type="submit" class="btn btn-success w-100">Sign Up</button>
        </form>

        <p class="mt-3 text-center">
            <span id="switch-text">New user?</span>
            <span class="form-switch-link" id="form-switcher">Create an account</span>
        </p>
    </div>
</div>

<script>
    // --- Configuration ---
    const BACKEND_URL = 'http://localhost:8080/api/auth';
    const SIGNIN_FORM = document.getElementById('signin-form');
    const SIGNUP_FORM = document.getElementById('signup-form');
    const ALERT_DIV = document.getElementById('auth-alert');
    const FORM_TITLE = document.getElementById('form-title');
    const FORM_SWITCHER = document.getElementById('form-switcher');
    const SWITCH_TEXT = document.getElementById('switch-text');

    // --- Utility Functions ---

    // Function to show and style the alert message
    function showAlert(message, type = 'danger') {
        ALERT_DIV.textContent = message;
        ALERT_DIV.className = `alert alert-${type} text-center`;
    }

    // Function to toggle between sign-in and sign-up forms
    FORM_SWITCHER.addEventListener('click', () => {
        if (SIGNIN_FORM.classList.contains('d-none')) {
            // Switch to Sign In
            SIGNIN_FORM.classList.remove('d-none');
            SIGNUP_FORM.classList.add('d-none');
            FORM_TITLE.textContent = 'Sign In';
            SWITCH_TEXT.textContent = 'New user?';
            FORM_SWITCHER.textContent = 'Create an account';
        } else {
            // Switch to Sign Up
            SIGNIN_FORM.classList.add('d-none');
            SIGNUP_FORM.classList.remove('d-none');
            FORM_TITLE.textContent = 'Sign Up';
            SWITCH_TEXT.textContent = 'Already have an account?';
            FORM_SWITCHER.textContent = 'Sign In';
        }
        ALERT_DIV.classList.add('d-none'); // Hide previous alert
    });

    // Function to gather form data into a JSON object
    function getFormData(form) {
        const data = {};
        const formData = new FormData(form);
        for (const [key, value] of formData.entries()) {
            data[key] = value;
        }

        // Special handling for the hidden 'role' field in signup form
        if(form.id === 'signup-form' && data.role) {
            data.role = [data.role]; // Convert 'user' string to ["user"] array for Spring backend
        }

        return data;
    }

    // --- Sign In Handler ---
    SIGNIN_FORM.addEventListener('submit', async (e) => {
        e.preventDefault();
        showAlert('Signing in...', 'info');

        const formData = getFormData(SIGNIN_FORM);

        try {
            const response = await fetch(`${BACKEND_URL}/signin`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // We do NOT need 'credentials: include' here yet, as no cookie is set.
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (response.ok) {
                // SUCCESS: The server has set the HTTP-only cookie in the browser.
                showAlert('Sign In Successful! Redirecting...', 'success');

                // 1. You can now use the credentials: 'include' option in future fetches.
                // 2. Redirect the user to the main application page (e.g., checkout or home)
                setTimeout(() => {
                    window.location.href = '/checkout.html'; // Adjust this path as needed
                }, 1000);

            } else {
                // FAILURE (e.g., 401 Unauthorized or 400 Bad Request)
                showAlert(result.message || 'Login failed. Check your credentials.', 'danger');
            }
        } catch (error) {
            console.error('Sign In Error:', error);
            showAlert('A network error occurred during sign-in.', 'danger');
        }
    });

    // --- Sign Up Handler ---
    SIGNUP_FORM.addEventListener('submit', async (e) => {
        e.preventDefault();
        showAlert('Registering new user...', 'info');

        const formData = getFormData(SIGNUP_FORM);

        try {
            const response = await fetch(`${BACKEND_URL}/signup`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (response.ok) {
                // SUCCESS: User created in the database
                showAlert('Sign Up Successful! Please sign in now.', 'success');
                // Auto-switch to the sign-in form
                FORM_SWITCHER.click();
            } else {
                // FAILURE (e.g., 400 Bad Request - Username/Email already exists)
                showAlert(result.message || 'Registration failed. Try a different username/email.', 'danger');
            }
        } catch (error) {
            console.error('Sign Up Error:', error);
            showAlert('A network error occurred during sign-up.', 'danger');
        }
    });

    // Initial load: Hide alert
    document.addEventListener('DOMContentLoaded', () => {
        ALERT_DIV.classList.add('d-none');
    });
</script>

</body>
</html>