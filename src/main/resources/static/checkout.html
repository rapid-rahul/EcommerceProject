<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-commerce Project Checkout</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <style>
        .container {
            max-width: 600px;
            margin-top: 50px;
        }
        .order-summary {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4 text-center">Secure Checkout</h2>

    <div class="order-summary mb-4">
        <h4 class="mb-3 text-primary">Order Summary</h4>
        <ul class="list-group mb-3">
            <li class="list-group-item d-flex justify-content-between">
                <div>
                    <h6 class="my-0">Product A</h6>
                    <small class="text-muted">Quantity: 2</small>
                </div>
                <span class="text-muted">‚Çπ8250.00</span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
                <span>Total (INR)</span>
                <strong>‚Çπ8250.00</strong>
            </li>
        </ul>
        <button id="pay-button" class="btn btn-success btn-lg w-100">Proceed to Payment</button>
    </div>

    <div id="status-message" class="alert alert-info" role="alert">
        Click "Proceed to Payment" to initiate the transaction.
    </div>

    <div id="payment-details" class="card mt-4" style="display: none;">
        <div class="card-header bg-success text-white">
            Payment Verification Data
        </div>
        <div class="card-body">
            <p><strong>Step 1: Razorpay Order ID (from backend)</strong></p>
            <p id="order-id-display" class="border p-2 bg-light"></p>

            <p><strong>Step 2: Razorpay Payment ID (for `providerPaymentId`)</strong></p>
            <p id="payment-id-display" class="border p-2 bg-warning"></p>

            <p><strong>Step 3: Razorpay Signature (for verification)</strong></p>
            <p id="signature-display" class="border p-2 bg-danger text-white"></p>

            <p class="mt-3">
                ‚ö†Ô∏è **ACTION REQUIRED:** Copy the three IDs above and use them to call your Spring Boot endpoint:
                <code class="text-primary">POST /api/order/users/payments/RAZORPAY</code>
            </p>
        </div>
    </div>
</div>

<script>
    // --- Configuration ---
    const BACKEND_URL = 'http://localhost:8080/api'; // Update if your port is different
    const TEST_AMOUNT_PAISE = "825000"; // Must match the amount in the summary (‚Çπ100.00)
    const TEST_USER_EMAIL = 'user1@gmi.com'; // Must match a user email known to AuthUtil/database
    const RAZORPAY_KEY_ID = 'rzp_test_RLylh8YWpUUx2j'; // <--- üö® REPLACE with your actual Test Key ID üö®

    document.getElementById('pay-button').onclick = async function() {
        // 1. Initiate Order Creation (Call Spring Boot /api/payments/create)
        document.getElementById('status-message').className = 'alert alert-warning';
        document.getElementById('status-message').innerHTML = 'Initiating payment... Calling ' + BACKEND_URL + '/payments/create';

        let orderData;
        try {
            const response = await fetch(BACKEND_URL + '/payments/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // NOTE: We are hardcoding the request body for testing
                body: JSON.stringify({
                    amount: TEST_AMOUNT_PAISE,
                    userId: TEST_USER_EMAIL
                    // orderId is optional/ignored by your service implementation
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error('Backend failed to create Razorpay Order: ' + JSON.stringify(error));
            }
            orderData = await response.json();

            document.getElementById('order-id-display').textContent = orderData.razorpayOrderId;
            document.getElementById('status-message').innerHTML = 'Razorpay Order ID created. Opening checkout...';

        } catch (error) {
            document.getElementById('status-message').className = 'alert alert-danger';
            document.getElementById('status-message').innerHTML = 'Error: ' + error.message;
            return;
        }

        // 2. Configure and Open Razorpay Checkout
        var options = {
            "key": RAZORPAY_KEY_ID,
            "amount": orderData.amount,
            "currency": orderData.currency,
            "name": "E-commerce Project",
            "description": "Payment for Order " + orderData.razorpayOrderId,
            "order_id": orderData.razorpayOrderId,
            "handler": function (response) {
                // --- üéØ STEP 3: SUCCESS CALLBACK - CAPTURE TOKENS üéØ ---

                // Display the captured tokens
                document.getElementById('payment-details').style.display = 'block';
                document.getElementById('payment-id-display').textContent = response.razorpay_payment_id;
                document.getElementById('signature-display').textContent = response.razorpay_signature;
                document.getElementById('status-message').className = 'alert alert-success';
                document.getElementById('status-message').innerHTML = 'Payment successful on Razorpay. Verification data captured!';

                // --- NOTE: In a real app, you would send an AJAX POST request here ---
                // e.g., send the response data along with addressId to your /api/order... endpoint.

            },
            "modal": {
                "ondismiss": function() {
                    document.getElementById('status-message').className = 'alert alert-info';
                    document.getElementById('status-message').innerHTML = 'Payment dismissed by user.';
                }
            },
            "prefill": {
                "email": TEST_USER_EMAIL,
            }
        };

        var rzp = new Razorpay(options);
        rzp.open();
    };
</script>

</body>
</html>